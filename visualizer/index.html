<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title></title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="./visualizer/style.css">
</head>

<body>
    <form class="state-interface" id="loadFile">
        <label>
            Click to select a text file
            <input type="file" name="file" oninput="uploadFile()">
        </label>
    </form>
    <pre class="state-interface" id="file-input"></pre>
    <div class="state-interface" id="controllers">
        <div style="text-align: center;">
            <button onclick="reset()">Reset</button>
            <button onclick="play()">Simulate</button>
        </div>
        <div style="padding-top: 12px; color: white">Rover locations are logged on the console.</div>
    </div>
    <div class="state-interface" id="zone">
        <div class="state-interface" id="tank">
            <div class="wrapper">
                <div class="body"></div>
                <div class="tracks"></div>
            </div>
        </div>
    </div>
    <script type="module">
        import { StateMachine } from '/visualizer/StatesMachine.js'
        import { StateMachine as Navigator } from '/bin/StateMachine.js'
        import handlers from '/bin/state-handlers/index.js'
        import Rover from '/bin/rover.js'

        const visualizerHandlers = {
            'load-file': loadFile,
            'initialize': initializeNavigator
        }
        const visualizer = new StateMachine({
            onEntry: state => {

                try {
                    if (state.name in visualizerHandlers) visualizerHandlers[state.name](visualizer)
                } catch (error) {
                    console.error('Error while calling state handler', { error, state })
                }
            },
            state: 'load-file'
        })

        window.visualizer = visualizer

        const navigator = new Navigator({
            onEntry: state => {
                try {
                    if (state.name == "navigate") simulate(navigator)
                    if (state.name in handlers) handlers[state.name](navigator)
                } catch (error) {
                    console.error('Error while calling state handler', { error, state })
                }
            },
            state: 'extract-instructions',
            debug: true
        })


        window.onload = visualizer.start()

        function show(el) {
            el.style.display = 'block'
        }

        function hide(el) {
            el.style.display = 'none'
        }

        function hideAll() {
            document.querySelectorAll('.state-interface').forEach(el => el.style.display = 'none')
        }

        function loadFile(machine) {
            show(document.getElementById('loadFile'))

            window.uploadFile = function () {
                if (window.File && window.FileReader && window.FileList && window.Blob) {
                    const form = document.querySelector('form')
                    const file = form.file.files[0];
                    const filePreview = document.getElementById('file-input')
                    form.reset()
                    const reader = new FileReader()


                    if (file.type.match(/text.*/)) {
                        reader.onload = function (event) {
                            navigator.context.file = event.target.result

                            hideAll()
                            hide(form)
                            show(filePreview)
                            filePreview.innerHTML = navigator.context.file

                            machine.action('next')
                        }
                    } else {
                        alert("Please select a text file!");
                    }

                    reader.readAsText(file);
                } else {
                    alert("Your browser is too old to support HTML5 File API");
                }
            }
        }

        function initializeNavigator() {
            navigator.start()
        }

        function setZone() {

            const { x, y } = navigator.context.zone

            document.documentElement.style.setProperty('--cols', x)
            document.documentElement.style.setProperty('--rows', y)
            show(document.getElementById('zone'))
        }

        function setStart() {
            const rover = stateMachine.context.rover
            try {
                rover.position = stateMachine.context.file.split('\n')[1]
                setRoverPosition()
                show(document.getElementById('tank'))
                stateMachine.context.playing = false
                handleState(stateMachine.next)
            } catch (error) {
                stateMachine.context.error = error
                handleState(stateMachine.error)
            }
        }

        function setRoverPosition() {
            const rover = stateMachine.context.rover
            console.log(rover.position)
            const [left, bottom, direction] = rover.position.split(' ')
            document.documentElement.style.setProperty('--left', left - 1)
            document.documentElement.style.setProperty('--bottom', bottom - 1)

            document.getElementById("tank").style.transform = {
                N: "rotate(0deg)",
                E: "rotate(90deg)",
                S: "rotate(180deg)",
                W: "rotate(270deg)"
            }[direction]
        }

        function simulate() {
            setZone()
            show(document.getElementById('controllers'))

            const rover = stateMachine.context.rover

            let commands = Array.from(stateMachine.context.file.split('\n')[2])

            window.play = function () {
                stateMachine.context.playing = true
                setTimeout(() => {
                    try {
                        if (stateMachine.context.playing) {
                            rover.process(commands.shift())
                            setRoverPosition()
                            if (commands.length && stateMachine.context.playing) play()
                        }
                    } catch (error) {
                        setRoverPosition()
                        setTimeout(() => {
                            alert(error.message)
                            window.reset()
                        }, 500)
                    }

                }, 600)
            }

            window.reset = function () {
                stateMachine.state = 'set-start'
                handleState(stateMachine.state)
            }
        }

        function showError() {
            alert(stateMachine.context.error.message)
            hideAll()
            handleState(stateMachine.next)
        }
    </script>
</body>

</html>