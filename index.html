<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title></title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <form class="state-interface" id="loadFile">
        <label>
            Click to select a text file
            <input type="file" name="file" oninput="uploadFile()">
        </label>
    </form>
    <pre class="state-interface" id="file-input"></pre>
    <div class="state-interface" id="controllers">
        <button onclick="reset()">Reset</button>
        <button onclick="play()">Simulate</button>
    </div>
    <div class="state-interface" id="zone">
        <div class="state-interface" id="tank">
            <div class="wrapper">
                <div class="body"></div>
                <div class="tracks"></div>
            </div>
        </div>
    </div>
    <script type="module">
        import { stateMachine } from './uiStatesMachine.js'
        import Rover from './rover.js'

        window.stateMachine = stateMachine

        function handleState({ name, actions }) {
            setTimeout(() => {
                ({
                    'load-file': loadFile,
                    'set-zone': setZone,
                    'set-start': setStart,
                    'simulate': simulate,
                    'show-error': showError
                }[name])(actions)
            }, 10)
        }

        window.onload = handleState(stateMachine.state)

        function show(el) {
            el.style.display = 'block'
        }

        function hide(el) {
            el.style.display = 'none'
        }

        function hideAll() {
            document.querySelectorAll('.state-interface').forEach(el => el.style.display = 'none')
        }

        function loadFile() {
            // show upload
            show(document.getElementById('loadFile'))

            window.uploadFile = function () {
                if (window.File && window.FileReader && window.FileList && window.Blob) {
                    const form = document.querySelector('form')
                    const file = form.file.files[0];
                    const filePreview = document.getElementById('file-input')
                    form.reset()
                    const reader = new FileReader()


                    if (file.type.match(/text.*/)) {
                        reader.onload = function (event) {
                            stateMachine.context.file = event.target.result

                            hideAll()
                            hide(form)
                            show(filePreview)
                            filePreview.innerHTML = stateMachine.context.file

                            handleState(stateMachine.next)
                        }
                    } else {
                        alert("Please select a text file!");
                    }

                    reader.readAsText(file);
                } else {
                    alert("Your browser is too old to support HTML5 File API");
                }
            }
        }


        function setZone() {
            const rover = stateMachine.context.rover = new Rover({
                zone: '1 1',
                start: '1 1 E',
                commands: ''
            })
            try {
                rover.zone = stateMachine.context.file.split('\n')[0]

                const [cols, rows] = rover.zone.split(' ')
                document.documentElement.style.setProperty('--cols', cols)
                document.documentElement.style.setProperty('--rows', rows)

                show(document.getElementById('zone'))

                handleState(stateMachine.next)
            } catch (error) {
                stateMachine.context.error = error
                handleState(stateMachine.error)
            }
        }

        function setStart() {
            const rover = stateMachine.context.rover
            try {
                rover.position = stateMachine.context.file.split('\n')[1]
                setRoverPosition()
                show(document.getElementById('tank'))
                stateMachine.context.playing = false
                handleState(stateMachine.next)
            } catch (error) {
                stateMachine.context.error = error
                handleState(stateMachine.error)
            }
        }

        function setRoverPosition() {
            const rover = stateMachine.context.rover
            const [left, bottom, direction] = rover.position.split(' ')
            document.documentElement.style.setProperty('--left', left - 1)
            document.documentElement.style.setProperty('--bottom', bottom - 1)

            document.getElementById("tank").style.transform = {
                N: "rotate(0deg)",
                E: "rotate(90deg)",
                S: "rotate(180deg)",
                W: "rotate(270deg)"
            }[direction]
        }

        function simulate() {
            show(document.getElementById('controllers'))

            const rover = stateMachine.context.rover

            let commands = Array.from(stateMachine.context.file.split('\n')[2])

            window.play = function () {
                stateMachine.context.playing = true
                setTimeout(() => {
                    try {
                        if (stateMachine.context.playing) {
                            rover.process(commands.shift())
                            setRoverPosition()
                            if (commands.length && stateMachine.context.playing) play()
                        }
                    } catch (error) {
                        setRoverPosition()
                        setTimeout(() => {
                            alert(error.message)
                            window.reset()
                        }, 500)
                    }

                }, 600)
            }

            window.reset = function () {
                stateMachine.state = 'set-start'
                handleState(stateMachine.state)
            }
        }

        function showError() {
            alert(stateMachine.context.error.message)
            hideAll()
            handleState(stateMachine.next)
        }
    </script>
</body>

</html>